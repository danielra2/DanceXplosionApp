{"version":3,"file":"click.js","sourceRoot":"","sources":["../../../src/hooks/click.ts"],"names":[],"mappings":"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","sourcesContent":["import type { mouseInteractionCallBack } from '@amplitude/rrweb-types';\nimport { MouseInteractions } from '@amplitude/rrweb-types';\nimport { Mirror } from '../utils/rrweb';\nimport { SessionReplayEventsManager as AmplitudeSessionReplayEventsManager } from '../typings/session-replay';\nimport { PayloadBatcher } from '../track-destination';\nimport { finder, Options as FinderOptions } from '../libs/finder';\nimport { getGlobalScope, ILogger } from '@amplitude/analytics-core';\nimport { UGCFilterRule, InteractionPerformanceConfig } from '../config/types';\nimport { getPageUrl } from '../helpers';\nimport { ScrollWatcher } from './scroll';\n\n// exported for testing\nexport type ClickEvent = {\n  timestamp: number;\n  x: number;\n  y: number;\n  viewportWidth: number;\n  viewportHeight: number;\n  pageUrl: string;\n  selector?: string;\n  type: 'click';\n};\n\n// exported for testing\nexport type ClickEventWithCount = ClickEvent & { count: number };\n\ntype Context = {\n  sessionId: string | number;\n  deviceIdFn: () => string | undefined;\n  eventsManager: AmplitudeSessionReplayEventsManager<'interaction', string>;\n  mirror: Mirror;\n  ugcFilterRules: UGCFilterRule[];\n  performanceOptions?: InteractionPerformanceConfig;\n};\n\nconst HOUR_IN_MILLISECONDS = 3_600_000;\n\nexport const clickNonBatcher: PayloadBatcher = ({ version, events }) => {\n  const clickEvents: ClickEvent[] = [];\n  events.forEach((evt: string) => {\n    const record = JSON.parse(evt) as Record<string, unknown>;\n    record.count = 1;\n    if (record.type === 'click') {\n      clickEvents.push(record as ClickEvent);\n    }\n  });\n  return { version, events: clickEvents };\n};\n\nexport const clickBatcher: PayloadBatcher = ({ version, events }) => {\n  const clickEvents: ClickEvent[] = [];\n  events.forEach((evt: string) => {\n    const record = JSON.parse(evt) as Record<string, unknown>;\n    if (record.type === 'click') {\n      clickEvents.push(record as ClickEvent);\n    }\n  });\n\n  const reduced = clickEvents.reduce<Record<string, ClickEventWithCount>>((prev, curr) => {\n    const { x, y, selector, timestamp } = curr;\n\n    // round down to nearest hour.\n    const hour = timestamp - (timestamp % HOUR_IN_MILLISECONDS);\n\n    const k = `${x}:${y}:${selector ?? ''}:${hour}`;\n    if (!prev[k]) {\n      prev[k] = { ...curr, timestamp: hour, count: 1 };\n    } else {\n      prev[k].count += 1;\n    }\n    return prev;\n  }, {});\n\n  return { version, events: Object.values(reduced) };\n};\n\nexport class ClickHandler {\n  private readonly logger: ILogger;\n  private readonly scrollWatcher: ScrollWatcher;\n\n  constructor(logger: ILogger, scrollWatcher: ScrollWatcher) {\n    this.logger = logger;\n    this.scrollWatcher = scrollWatcher;\n  }\n\n  createHook: (context: Context) => mouseInteractionCallBack = ({\n    eventsManager,\n    sessionId,\n    deviceIdFn,\n    mirror,\n    ugcFilterRules,\n    performanceOptions,\n  }) => {\n    return (e) => {\n      if (e.type !== MouseInteractions.Click) {\n        return;\n      }\n\n      const globalScope = getGlobalScope();\n      if (!globalScope) {\n        return;\n      }\n\n      const { location, innerHeight, innerWidth } = globalScope;\n      // it only makes sense to send events if a pageUrl exists\n      if (!location) {\n        return;\n      }\n\n      const { x, y } = e;\n      if (x === undefined || y === undefined) {\n        return;\n      }\n\n      const node = mirror.getNode(e.id);\n      let selector;\n      if (node) {\n        try {\n          selector = finder(\n            node as Element,\n            performanceOptions as Pick<FinderOptions, 'timeoutMs' | 'maxNumberOfTries' | 'threshold'>,\n          );\n        } catch (err) {\n          this.logger.debug('error resolving selector from finder');\n        }\n      }\n\n      const pageUrl = getPageUrl(location.href, ugcFilterRules);\n\n      const event: ClickEvent = {\n        x: x + this.scrollWatcher.currentScrollX,\n        y: y + this.scrollWatcher.currentScrollY,\n        selector,\n\n        viewportHeight: innerHeight,\n        viewportWidth: innerWidth,\n        pageUrl,\n        timestamp: Date.now(),\n        type: 'click',\n      };\n      const deviceId = deviceIdFn();\n      if (deviceId) {\n        eventsManager.addEvent({ sessionId, event: { type: 'interaction', data: JSON.stringify(event) }, deviceId });\n      }\n    };\n  };\n}\n"]}