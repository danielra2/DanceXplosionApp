{"version":3,"file":"rrweb-utils.js","sources":["../src/index.ts"],"sourcesContent":["type PrototypeOwner = Node | ShadowRoot | MutationObserver | Element;\ntype TypeofPrototypeOwner =\n  | typeof Node\n  | typeof ShadowRoot\n  | typeof MutationObserver\n  | typeof Element;\n\ntype BasePrototypeCache = {\n  Node: typeof Node.prototype;\n  ShadowRoot: typeof ShadowRoot.prototype;\n  MutationObserver: typeof MutationObserver.prototype;\n  Element: typeof Element.prototype;\n};\n\nconst testableAccessors = {\n  Node: ['childNodes', 'parentNode', 'parentElement', 'textContent'] as const,\n  ShadowRoot: ['host', 'styleSheets'] as const,\n  Element: ['shadowRoot', 'querySelector', 'querySelectorAll'] as const,\n  MutationObserver: [] as const,\n} as const;\n\nconst testableMethods = {\n  Node: ['contains', 'getRootNode'] as const,\n  ShadowRoot: ['getSelection'],\n  Element: [],\n  MutationObserver: ['constructor'],\n} as const;\n\nconst untaintedBasePrototype: Partial<BasePrototypeCache> = {};\n\ntype WindowWithZone = typeof globalThis & {\n  Zone?: {\n    __symbol__?: (key: string) => string;\n  };\n};\n\ntype WindowWithUnpatchedSymbols = typeof globalThis &\n  Record<string, TypeofPrototypeOwner>;\n\n/*\nAngular zone patches many things and can pass the untainted checks below, causing performance issues\nAngular zone, puts the unpatched originals on the window, and the names for hose on the zone object.\nSo, we get the unpatched versions from the window object if they exist.\nYou can rename Zone, but this is a good enough proxy to avoid going to an iframe to get the untainted versions.\nsee: https://github.com/angular/angular/issues/26948\n*/\nfunction angularZoneUnpatchedAlternative(key: keyof BasePrototypeCache) {\n  const angularUnpatchedVersionSymbol = (\n    globalThis as WindowWithZone\n  )?.Zone?.__symbol__?.(key);\n  if (\n    angularUnpatchedVersionSymbol &&\n    (globalThis as WindowWithUnpatchedSymbols)[angularUnpatchedVersionSymbol]\n  ) {\n    return (globalThis as WindowWithUnpatchedSymbols)[\n      angularUnpatchedVersionSymbol\n    ];\n  } else {\n    return undefined;\n  }\n}\n\nexport function getUntaintedPrototype<T extends keyof BasePrototypeCache>(\n  key: T,\n): BasePrototypeCache[T] {\n  if (untaintedBasePrototype[key])\n    return untaintedBasePrototype[key] as BasePrototypeCache[T];\n\n  const candidate =\n    angularZoneUnpatchedAlternative(key) ||\n    (globalThis[key] as TypeofPrototypeOwner);\n  const defaultPrototype = candidate.prototype as BasePrototypeCache[T];\n\n  // use list of testable accessors to check if the prototype is tainted\n  const accessorNames =\n    key in testableAccessors ? testableAccessors[key] : undefined;\n  const isUntaintedAccessors = Boolean(\n    accessorNames &&\n      // @ts-expect-error 2345\n      accessorNames.every((accessor: keyof typeof defaultPrototype) =>\n        Boolean(\n          Object.getOwnPropertyDescriptor(defaultPrototype, accessor)\n            ?.get?.toString()\n            .includes('[native code]'),\n        ),\n      ),\n  );\n\n  const methodNames = key in testableMethods ? testableMethods[key] : undefined;\n  const isUntaintedMethods = Boolean(\n    methodNames &&\n      methodNames.every(\n        // @ts-expect-error 2345\n        (method: keyof typeof defaultPrototype) =>\n          typeof defaultPrototype[method] === 'function' &&\n          defaultPrototype[method]?.toString().includes('[native code]'),\n      ),\n  );\n\n  if (isUntaintedAccessors && isUntaintedMethods) {\n    untaintedBasePrototype[key] = candidate.prototype as BasePrototypeCache[T];\n    return candidate.prototype as BasePrototypeCache[T];\n  }\n\n  try {\n    const iframeEl = document.createElement('iframe');\n    document.body.appendChild(iframeEl);\n    const win = iframeEl.contentWindow;\n    if (!win) return candidate.prototype as BasePrototypeCache[T];\n\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-explicit-any\n    const untaintedObject = (win as any)[key]\n      .prototype as BasePrototypeCache[T];\n    // cleanup\n    document.body.removeChild(iframeEl);\n\n    if (!untaintedObject) return defaultPrototype;\n\n    return (untaintedBasePrototype[key] = untaintedObject);\n  } catch {\n    return defaultPrototype;\n  }\n}\n\nconst untaintedAccessorCache: Record<\n  string,\n  (this: PrototypeOwner, ...args: unknown[]) => unknown\n> = {};\n\nexport function getUntaintedAccessor<\n  K extends keyof BasePrototypeCache,\n  T extends keyof BasePrototypeCache[K],\n>(\n  key: K,\n  instance: BasePrototypeCache[K],\n  accessor: T,\n): BasePrototypeCache[K][T] {\n  const cacheKey = `${key}.${String(accessor)}`;\n  if (untaintedAccessorCache[cacheKey])\n    return untaintedAccessorCache[cacheKey].call(\n      instance,\n    ) as BasePrototypeCache[K][T];\n\n  const untaintedPrototype = getUntaintedPrototype(key);\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  const untaintedAccessor = Object.getOwnPropertyDescriptor(\n    untaintedPrototype,\n    accessor,\n  )?.get;\n\n  if (!untaintedAccessor) return instance[accessor];\n\n  untaintedAccessorCache[cacheKey] = untaintedAccessor;\n\n  return untaintedAccessor.call(instance) as BasePrototypeCache[K][T];\n}\n\ntype BaseMethod<K extends keyof BasePrototypeCache> = (\n  this: BasePrototypeCache[K],\n  ...args: unknown[]\n) => unknown;\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst untaintedMethodCache: Record<string, BaseMethod<any>> = {};\nexport function getUntaintedMethod<\n  K extends keyof BasePrototypeCache,\n  T extends keyof BasePrototypeCache[K],\n>(\n  key: K,\n  instance: BasePrototypeCache[K],\n  method: T,\n): BasePrototypeCache[K][T] {\n  const cacheKey = `${key}.${String(method)}`;\n  if (untaintedMethodCache[cacheKey])\n    return untaintedMethodCache[cacheKey].bind(\n      instance,\n    ) as BasePrototypeCache[K][T];\n\n  const untaintedPrototype = getUntaintedPrototype(key);\n  const untaintedMethod = untaintedPrototype[method];\n\n  if (typeof untaintedMethod !== 'function') return instance[method];\n\n  untaintedMethodCache[cacheKey] = untaintedMethod as BaseMethod<K>;\n\n  return untaintedMethod.bind(instance) as BasePrototypeCache[K][T];\n}\n\nexport function childNodes(n: Node): NodeListOf<Node> {\n  return getUntaintedAccessor('Node', n, 'childNodes');\n}\n\nexport function parentNode(n: Node): ParentNode | null {\n  return getUntaintedAccessor('Node', n, 'parentNode');\n}\n\nexport function parentElement(n: Node): HTMLElement | null {\n  return getUntaintedAccessor('Node', n, 'parentElement');\n}\n\nexport function textContent(n: Node): string | null {\n  return getUntaintedAccessor('Node', n, 'textContent');\n}\n\nexport function contains(n: Node, other: Node): boolean {\n  return getUntaintedMethod('Node', n, 'contains')(other);\n}\n\nexport function getRootNode(n: Node): Node {\n  return getUntaintedMethod('Node', n, 'getRootNode')();\n}\n\nexport function host(n: ShadowRoot): Element | null {\n  if (!n || !('host' in n)) return null;\n  return getUntaintedAccessor('ShadowRoot', n, 'host');\n}\n\nexport function styleSheets(n: ShadowRoot): StyleSheetList {\n  return n.styleSheets;\n}\n\nexport function shadowRoot(n: Node): ShadowRoot | null {\n  if (!n || !('shadowRoot' in n)) return null;\n  return getUntaintedAccessor('Element', n as Element, 'shadowRoot');\n}\n\nexport function querySelector(n: Element, selectors: string): Element | null {\n  return getUntaintedAccessor('Element', n, 'querySelector')(selectors);\n}\n\nexport function querySelectorAll(\n  n: Element,\n  selectors: string,\n): NodeListOf<Element> {\n  return getUntaintedAccessor('Element', n, 'querySelectorAll')(selectors);\n}\n\nexport function mutationObserverCtor(): (typeof MutationObserver)['prototype']['constructor'] {\n  return getUntaintedPrototype('MutationObserver').constructor;\n}\n\nexport default {\n  childNodes,\n  parentNode,\n  parentElement,\n  textContent,\n  contains,\n  getRootNode,\n  host,\n  styleSheets,\n  shadowRoot,\n  querySelector,\n  querySelectorAll,\n  mutationObserver: mutationObserverCtor,\n};\n"],"names":[],"mappings":"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"}